<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Elim Farms Dashboard</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;500;600;700&family=Georgia:wght@400;700&display=swap" rel="stylesheet">

<style>
:root {
    /* üåø LUXURIOUS COLOR PALETTE */
    --accent: #1e4a1e;        /* Deeper, more sophisticated forest green */
    --accent-light: #2e6b2e;  /* Richer light green for gradients */
    --accent-soft: #e8f3e8;   /* Soft mint for hover backgrounds */
    --high-yield: #0f5c3f;    /* Deep emerald - more premium */
    --selected: #e6b800;      /* Rich golden yellow - luxurious */
    --selected-light: #ffd966; /* Soft gold for glow */
    --default: #2c5282;       /* Deeper navy blue - more sophisticated */
    --default-light: #4299e1; /* Brighter blue for accents */
    --ui: #1a1e24;           /* Darker, richer text */
    --muted: #5a6570;        /* Warmer gray */
    --panel-width: 420px;
    --safe-margin: 3%;
    
    /* Typography scale */
    --text-xs: 13px;
    --text-sm: 15px;
    --text-base: 17px;
    --text-lg: 20px;
    --text-xl: 28px;
    --text-2xl: 36px;
    
    /* Font families */
    --font-primary: 'Libre Franklin', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-heading: 'Georgia', 'Times New Roman', serif;
    
    /* Animation durations */
    --duration-instant: 120ms;
    --duration-fast: 220ms;
    --duration-normal: 500ms;
    --duration-slow: 1000ms;
    --duration-zoom-in: 2400ms;
    --duration-zoom-out: 1800ms;
    
    /* Z-index scale */
    --z-base: 10;
    --z-panels: 50;
    --z-header: 100;
    --z-tooltip: 200;
    --z-loading: 1000;
}

* {
    box-sizing: border-box;
}

body {
    font-family: var(--font-primary);
    margin: 0;
    padding: 0;
    background: #f5f7fa;
    color: var(--ui);
    overflow: hidden;
    height: 100vh;
    font-size: var(--text-base);
    line-height: 1.5;
}

/* Headers use Georgia */
h1, h2, h3, h4, h5, h6, 
.panel-header, 
.block-details-title,
.legend-title,
.stat-label {
    font-family: var(--font-heading);
    font-weight: 700;
}

/* Main container - Panel on LEFT, map on RIGHT */
#container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: row-reverse;
}

/* Map container - now on right */
#map-container {
    flex: 1;
    position: relative;
    overflow: hidden;
}

svg#map {
    width: 100%;
    height: 100%;
    display: block;
    background: linear-gradient(145deg, #f0f4f8 0%, #e6ecf0 100%);
}

/* Farm block styles */
.block {
    stroke: #000000;
    stroke-width: 4px;
    cursor: pointer;
    paint-order: stroke;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
    transition: all var(--duration-fast) cubic-bezier(0.23, 1, 0.32, 1);
    vector-effect: non-scaling-stroke;
}

.block:hover {
    stroke-width: 8px;
    stroke: #ffffff;
    filter: drop-shadow(0 12px 24px rgba(0,0,0,0.3)) brightness(1.1);
    transform: scale(1.02);
    z-index: 100;
    transition: all var(--duration-fast) cubic-bezier(0.23, 1, 0.32, 1);
}

.block.selected {
    stroke-width: 8px;
    stroke: #ffffff;
    filter: drop-shadow(0 0 20px rgba(230, 184, 0, 0.8)) brightness(1.1);
    z-index: 200;
    animation: selectedPulse 2s infinite ease-in-out;
}

@keyframes selectedPulse {
    0% { filter: drop-shadow(0 0 20px rgba(230, 184, 0, 0.7)) brightness(1.1); }
    50% { filter: drop-shadow(0 0 30px rgba(230, 184, 0, 0.9)) brightness(1.15); }
    100% { filter: drop-shadow(0 0 20px rgba(230, 184, 0, 0.7)) brightness(1.1); }
}

.block.faded {
    opacity: 0.15;
    filter: grayscale(0.5);
    transition: opacity var(--duration-normal) ease, filter var(--duration-normal) ease;
}

.block-label {
    font-size: var(--text-xs);
    font-weight: 600;
    fill: #1a1e24;
    text-anchor: middle;
    pointer-events: none;
    user-select: none;
    transition: opacity var(--duration-normal) ease;
    font-family: var(--font-primary);
    paint-order: stroke;
    stroke: rgba(255,255,255,0.9);
    stroke-width: 2.5px;
    stroke-linecap: round;
    stroke-linejoin: round;
    dominant-baseline: middle;
}

.block-label.hidden {
    opacity: 0;
}

/* Panel - now on LEFT side */
#panel {
    width: var(--panel-width);
    background: white;
    padding: 0;
    box-shadow: 5px 0 30px rgba(0,0,0,0.06);
    z-index: var(--z-panels);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: opacity var(--duration-normal) ease, 
                visibility var(--duration-normal) ease;
}

.panel-content {
    padding: 30px 28px;
    flex: 1;
    overflow-y: auto;
}

.panel-header {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
    color: white;
    padding: 24px 28px;
    margin: 0;
    font-size: var(--text-xl);
    font-weight: 700;
    transition: all var(--duration-fast) ease;
    letter-spacing: 0.01em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 3px solid rgba(255,255,255,0.1);
}

/* Close button in header */
.header-close-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    transition: all var(--duration-fast) ease;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.3);
}

.header-close-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1);
    border-color: rgba(255,255,255,0.5);
}

/* Farm summary stats */
.summary-stats {
    transition: opacity var(--duration-normal) ease,
                max-height var(--duration-normal) ease,
                padding var(--duration-normal) ease;
    overflow: hidden;
}

.summary-stats.hidden {
    opacity: 0;
    max-height: 0;
    padding: 0;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 14px 0;
    border-bottom: 1px solid #edf2f7;
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    color: #4a5568;
    font-weight: 600;
    font-size: var(--text-base);
    letter-spacing: 0.01em;
}

.stat-value {
    color: #1a202c;
    font-weight: 700;
    font-size: var(--text-base);
    font-family: var(--font-primary);
}

/* Block details section */
.block-details-section {
    transition: opacity var(--duration-normal) ease,
                max-height var(--duration-normal) ease,
                padding var(--duration-normal) ease;
    overflow: hidden;
    opacity: 0;
    max-height: 0;
    padding: 0;
}

.block-details-section.visible {
    opacity: 1;
    max-height: 2000px;
    padding: 0;
}

/* Remove old clear button */
.block-details-header {
    display: none;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid #edf2f7;
    transition: background-color var(--duration-fast);
}

.detail-row:hover {
    background-color: #fafbfc;
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    color: #4a5568;
    font-weight: 600;
    flex: 1;
    font-size: var(--text-base);
    letter-spacing: 0.01em;
}

.detail-value {
    color: #1a202c;
    font-weight: 700;
    flex: 1;
    text-align: right;
    font-size: var(--text-base);
    font-family: var(--font-primary);
}

/* Chart for plant density */
.density-chart {
    width: 100%;
    height: 100px;
    background: #edf2f7;
    border-radius: 12px;
    margin: 25px 0 15px 0;
    position: relative;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
}

.density-fill {
    height: 100%;
    background: linear-gradient(90deg, #9ae6b4, var(--accent));
    border-radius: 12px;
    transition: width var(--duration-slow) cubic-bezier(0.4, 0, 0.2, 1);
}

.chart-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #1a202c;
    font-weight: 700;
    font-size: var(--text-base);
    text-shadow: 0 1px 3px rgba(255,255,255,0.8);
    font-family: var(--font-heading);
    background: rgba(255,255,255,0.9);
    padding: 4px 12px;
    border-radius: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
}

/* Loading states */
.loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.98);
    padding: 24px 36px;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 16px;
    z-index: var(--z-loading);
    font-family: var(--font-primary);
    font-size: var(--text-base);
    border: 1px solid rgba(0,0,0,0.04);
}

.loading-spinner {
    width: 28px;
    height: 28px;
    border: 3px solid rgba(30, 74, 30, 0.08);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Error state */
.error-state {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    padding: 48px;
    background: white;
    border-radius: 24px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.08);
    z-index: var(--z-loading);
    border: 1px solid rgba(0,0,0,0.04);
}

.error-state-icon {
    font-size: 72px;
    margin-bottom: 24px;
}

.error-state-title {
    font-size: var(--text-xl);
    color: #1a202c;
    margin-bottom: 12px;
    font-family: var(--font-heading);
}

.error-state-message {
    color: #718096;
    margin-bottom: 24px;
    font-size: var(--text-base);
}

.retry-button {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
    color: white;
    border: none;
    padding: 14px 28px;
    border-radius: 40px;
    font-size: var(--text-base);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--duration-fast);
    font-family: var(--font-primary);
    box-shadow: 0 4px 12px rgba(30, 74, 30, 0.2);
}

.retry-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(30, 74, 30, 0.25);
}

/* Tooltip - SIMPLIFIED */
.tooltip {
    position: absolute;
    background: rgba(26, 30, 36, 0.98);
    color: white;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: var(--text-sm);
    pointer-events: none;
    z-index: var(--z-tooltip);
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    max-width: 200px;
    backdrop-filter: blur(4px);
    line-height: 1.5;
    transition: opacity var(--duration-instant) ease;
    font-family: var(--font-primary);
    border: 1px solid rgba(255,255,255,0.1);
}

.tooltip:after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: rgba(26, 30, 36, 0.98);
}

/* Navigation buttons - REPOSITIONED TO RIGHT EDGE */
.navigation-buttons {
    position: absolute;
    right: var(--safe-margin);
    bottom: calc(var(--safe-margin) + 210px);
    display: flex;
    gap: 12px;
    z-index: var(--z-base);
}

.nav-button {
    background: white;
    color: var(--accent);
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    font-size: 22px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    transition: all var(--duration-fast);
    font-family: var(--font-primary);
    border: 1px solid rgba(0,0,0,0.05);
}

.nav-button:hover:not(:disabled) {
    background: var(--accent);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 12px 28px rgba(30, 74, 30, 0.3);
}

.nav-button:active:not(:disabled) {
    transform: translateY(0);
}

.nav-button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none !important;
    background: #f7fafc;
    color: #a0aec0;
}

/* Zoom and rotate controls - REPOSITIONED TO RIGHT EDGE, ABOVE NAV BUTTONS */
.zoom-controls {
    position: absolute;
    right: var(--safe-margin);
    bottom: calc(var(--safe-margin) + 300px); /* Positioned above navigation buttons */
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: var(--z-base);
}

.zoom-button {
    background: white;
    color: var(--accent);
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    transition: all var(--duration-fast);
    font-family: var(--font-primary);
    border: 1px solid rgba(0,0,0,0.03);
}

.zoom-button:hover {
    background: var(--accent);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 8px 18px rgba(30, 74, 30, 0.25);
}

#rotate-view {
    background: white;
    color: #8a6e4b;
    border: 1px solid rgba(138, 110, 75, 0.2);
}

#rotate-view:hover {
    background: #8a6e4b;
    color: white;
}

#rotate-view.rotated {
    background: #8a6e4b;
    color: white;
}

/* Legend - REPOSITIONED TO RIGHT EDGE, ABOVE ZOOM CONTROLS */
/* Legend - Positioned to the RIGHT of the panel */
.legend {
    position: absolute;
    right: calc(var(--safe-margin)); /* Positioned right after the panel */
    bottom: var(--safe-margin); /* At the bottom */
    background: rgba(255,255,255,0.95);
    padding: 18px 22px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    z-index: var(--z-base);
    min-width: 150px;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.5);
}

.legend-title {
    margin: 0 0 12px 0;
    color: var(--accent);
    font-size: var(--text-lg);
    font-weight: 700;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    margin-right: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

.legend-text {
    font-size: var(--text-sm);
    color: #4a5568;
    font-family: var(--font-primary);
    font-weight: 500;
}
</style>
</head>

<body>
<div id="container">
    <div id="map-container">
        <svg id="map"></svg>
        
        <!-- Legend - repositioned to RIGHT edge via CSS -->
        <div class="legend">
            <div class="legend-title">Block Status</div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--default);"></div>
                <div class="legend-text">Normal</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--selected);"></div>
                <div class="legend-text">Selected</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--high-yield);"></div>
                <div class="legend-text">High Yield</div>
            </div>
        </div>
        
        <!-- Zoom controls - repositioned to RIGHT edge via CSS -->
        <div class="zoom-controls">
            <button class="zoom-button" id="zoom-in" title="Zoom In">+</button>
            <button class="zoom-button" id="zoom-out" title="Zoom Out">‚àí</button>
            <button class="zoom-button" id="reset-view" title="Reset View">‚Ü∫</button>
            <button class="zoom-button" id="rotate-view" title="Rotate Map 90¬∞">‚Üª</button>
        </div>
        
        <!-- Navigation - repositioned to RIGHT edge via CSS -->
        <div class="navigation-buttons">
            <button class="nav-button" id="prev-block" title="Previous Block (‚Üê)">‚Üê</button>
            <button class="nav-button" id="next-block" title="Next Block (‚Üí)">‚Üí</button>
        </div>
        
        <!-- Loading -->
        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <span id="loading-text">Loading farm data...</span>
        </div>
        
        <!-- Error State -->
        <div id="error-state" class="error-state" style="display: none;">
            <div class="error-state-icon">‚ö†Ô∏è</div>
            <div class="error-state-title">Failed to Load Data</div>
            <div class="error-state-message" id="error-message">Please check your connection and try again.</div>
            <button class="retry-button" id="retry-btn">Retry</button>
        </div>
    </div>
    
    <!-- Panel -->
    <div id="panel">
        <h3 class="panel-header" id="panel-title">
            <span>üçå Elim Farms Dashboard <span style="font-size: 16px; opacity: 0.8; font-weight: 400; font-family: var(--font-primary);">v3.0</span></span>
        </h3>
        
        <div class="panel-content">
            <!-- Farm-wide statistics -->
            <div id="summary" class="summary-stats">
                <div class="stat-item">
                    <span class="stat-label">Total Area</span>
                    <span class="stat-value" id="total-area">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Blocks</span>
                    <span class="stat-value" id="total-blocks">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Trees</span>
                    <span class="stat-value" id="total-trees">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Farm Plant Density</span>
                    <span class="stat-value" id="farm-density">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Bunch Weight</span>
                    <span class="stat-value" id="avg-bunch-weight-farm">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Yield</span>
                    <span class="stat-value" id="avg-yield">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Est. Total Yield</span>
                    <span class="stat-value" id="total-yield">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">High Yield Blocks</span>
                    <span class="stat-value" id="high-yield-count">-</span>
                </div>
            </div>
            
            <!-- Block Details Section -->
            <div id="blockDetailsSection" class="block-details-section">
                <div id="blockInfo" class="block-details">
                    <div class="detail-row">
                        <span class="detail-label">Block Size</span>
                        <span class="detail-value" id="block-size">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Plants per Hectare</span>
                        <span class="detail-value" id="plants-per-hectare">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Trees</span>
                        <span class="detail-value" id="block-total-trees">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Avg Bunch Weight</span>
                        <span class="detail-value" id="avg-bunch-weight">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Est. Yield</span>
                        <span class="detail-value" id="block-yield">-</span>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="font-weight: 700; font-size: var(--text-lg); font-family: var(--font-heading); color: var(--accent);">Plant Density</span>
                            <span id="density-label" style="font-weight: 600; color: var(--accent); font-size: var(--text-base); font-family: var(--font-primary);">-</span>
                        </div>
                        <div class="density-chart">
                            <div class="density-fill" id="density-fill" style="width: 0%"></div>
                            <div class="chart-label" id="density-chart-label">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="tooltip" class="tooltip" style="display: none;"></div>

<script>
// ==========================================
// Farm Dashboard Application - v3.0 Enhanced
// ==========================================

const FarmDashboard = {
    // State Management
    state: {
        geoData: null,
        csvData: [],
        dataMap: {},
        selectedBlock: null,
        selectedBlockIndex: -1,
        blocks: [],
        currentTransform: d3.zoomIdentity,
        initialTransform: null,
        isRotated: false,
        rotationAngle: 0,
        blockRanks: {}
    },
    
    // Configuration
    config: {
        colors: {
            default: "#2c5282",
            selected: "#e6b800",
            highYield: "#0f5c3f"
        },
        thresholds: {
            highYield: 1000,
            labelTruncate: 12
        },
        map: {
            scale: 0.07,
            verticalPositionRatio: 0.01,
            horizontalNudgeRatio: 0.05,
            minZoomScale: 1,
            maxZoomScale: 8,
            zoomPadding: 0.9,
            zoomNudgeFactor: 0.6,
            labelBaseFontSize: 11,
            // MANUAL POSITIONING CONTROLS
            defaultCenterX: 0.7,
            defaultCenterY: 0.005,
            rotatedCenterX: 0.55,
            rotatedCenterY: 0.5
        },
        animation: {
            instant: 120,
            fast: 220,
            normal: 500,
            slow: 1000,
            zoomIn: 2400,
            zoomOut: 1800,
            hover: 180
        },
        tooltip: {
            throttleMs: 30,
            offsetX: 15,
            offsetY: -15
        },
        retry: {
            maxAttempts: 3,
            delayMs: 2000
        }
    },
    
    // DOM References
    refs: {},
    
    // Performance tracking
    performance: {
        initStartTime: null,
        initEndTime: null
    },
    
    // ==========================================
    // INITIALIZATION
    // ==========================================
    
    async init(retries = 3) {
        this.performance.initStartTime = performance.now();
        console.log("üçå Initializing Elim Farms Dashboard v3.0...");
        
        this.cacheDOM();
        this.showLoading(true, "Loading farm data...");
        
        try {
            const [geoData, csvData] = await Promise.all([
                d3.json("ElimFarms.geojson"),
                d3.csv("farm_data.csv")
            ]);
            
            this.validateData(geoData, csvData);
            
            console.log("‚úì Data loaded:", {
                geoFeatures: geoData.features.length,
                csvRows: csvData.length
            });
            
            this.state.geoData = geoData;
            this.state.csvData = csvData;
            
            this.buildDataMap();
            this.calculateBlockRanks();
            
            this.initMap();
            this.initZoom();
            this.initTooltip();
            this.initEventListeners();
            
            this.drawMap();
            this.updateSummary();
            
            this.showLoading(false);
            this.hideError();
            
            this.performance.initEndTime = performance.now();
            const initTime = (this.performance.initEndTime - this.performance.initStartTime).toFixed(2);
            console.log(`‚úÖ Dashboard initialized successfully in ${initTime}ms`);
            
        } catch (error) {
            console.error("‚ùå Initialization error:", error);
            this.showLoading(false);
            
            if (retries > 0) {
                console.log(`üîÑ Retrying... (${retries} attempts left)`);
                this.showLoading(true, `Retrying... (${retries} attempts left)`);
                setTimeout(() => this.init(retries - 1), this.config.retry.delayMs);
            } else {
                this.showError(error.message || "Failed to load farm data");
            }
        }
    },
    
    cacheDOM() {
        this.refs = {
            container: d3.select("#map-container"),
            svg: d3.select("#map"),
            panel: d3.select("#panel"),
            panelTitle: d3.select("#panel-title"),
            loading: d3.select("#loading"),
            loadingText: d3.select("#loading-text"),
            errorState: d3.select("#error-state"),
            errorMessage: d3.select("#error-message"),
            tooltip: d3.select("#tooltip"),
            summaryStats: d3.select("#summary"),
            blockDetailsSection: d3.select("#blockDetailsSection")
        };
    },
    
    validateData(geoData, csvData) {
        if (!geoData?.features?.length) {
            throw new Error("Invalid GeoJSON: No features found");
        }
        if (!csvData?.length) {
            throw new Error("Invalid CSV: No data rows found");
        }
        
        const requiredFields = ["Block Name", "Block Size", "Plants per hectare", "Average Bunch Weight"];
        const firstRow = csvData[0];
        
        requiredFields.forEach(field => {
            if (!(field in firstRow)) {
                throw new Error(`Missing required field: ${field}`);
            }
        });
    },
    
    buildDataMap() {
        this.state.dataMap = {};
        this.state.blocks = [];
        
        this.state.csvData.forEach((d, i) => {
            const blockName = d["Block Name"];
            if (!blockName || blockName.trim() === "") {
                console.warn(`Row ${i}: Missing or empty Block Name, skipping`);
                return;
            }
            this.state.dataMap[blockName] = d;
            this.state.blocks.push(blockName);
        });
        
        if (this.state.blocks.length === 0) {
            throw new Error("No valid blocks found in data");
        }
        
        console.log(`‚úì Built data map: ${this.state.blocks.length} blocks`);
    },
    
    calculateBlockRanks() {
        const blocksWithYield = this.state.blocks.map(blockName => {
            const data = this.state.dataMap[blockName];
            const plants = parseFloat(data["Plants per hectare"]) || 0;
            const weight = parseFloat(data["Average Bunch Weight"]) || 0;
            const yield_value = plants * weight;
            return { name: blockName, yield: yield_value };
        }).sort((a, b) => b.yield - a.yield);
        
        blocksWithYield.forEach((item, index) => {
            this.state.blockRanks[item.name] = index + 1;
        });
    },
    
    // ==========================================
    // MAP INITIALIZATION
    // ==========================================
    
    initMap() {
        const container = this.refs.container;
        const width = container.node().clientWidth;
        const height = container.node().clientHeight;
        
        const svg = this.refs.svg
            .attr("width", width)
            .attr("height", height);
        
        svg.append("defs").html(`
            <filter id="pulseEffect" x="-30%" y="-30%" width="160%" height="160%">
                <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur" />
                <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 20 -8" result="pulse" />
                <feBlend in="SourceGraphic" in2="pulse" mode="screen" />
            </filter>
        `);
        
        const rotationGroup = svg.append("g").attr("id", "rotation-group");
        const mapGroup = rotationGroup.append("g").attr("id", "map-group");
        mapGroup.append("g").attr("id", "blocks-group");
        mapGroup.append("g").attr("id", "labels-group");
        
        const projection = d3.geoIdentity().reflectY(true);
        const bounds = d3.geoBounds(this.state.geoData);
        
        const panelWidth = parseInt(getComputedStyle(document.getElementById('panel')).width) || 420;
        const availableWidth = width - panelWidth;
        
        const widthRatio = (bounds[1][0] - bounds[0][0]) / availableWidth;
        const heightRatio = (bounds[1][1] - bounds[0][1]) / height;
        const scale = this.config.map.scale / Math.max(widthRatio, heightRatio);
        
        const horizontalNudge = availableWidth * this.config.map.horizontalNudgeRatio;
        const centerX = (availableWidth * this.config.map.defaultCenterX) + horizontalNudge;
        const centerY = height * this.config.map.defaultCenterY;
        
        projection.scale(scale).translate([centerX, centerY]);
        
        this.state.projection = projection;
        this.state.path = d3.geoPath().projection(projection);
        this.state.width = width;
        this.state.height = height;
        this.state.availableWidth = availableWidth;
        this.state.initialTransform = d3.zoomIdentity;
        this.state.dimensions = { width, height, availableWidth, panelWidth };
        
        console.log("‚úì Map initialized:", {
            dimensions: `${width}x${height}`,
            availableWidth,
            scale: scale.toFixed(2),
            center: `(${centerX.toFixed(1)}, ${centerY.toFixed(1)})`
        });
    },
    
    initZoom() {
        const svg = this.refs.svg;
        
        this.state.zoom = d3.zoom()
            .scaleExtent([this.config.map.minZoomScale, this.config.map.maxZoomScale])
            .on("zoom", (event) => {
                this.state.currentTransform = event.transform;
                d3.select("#map-group").attr("transform", event.transform);
                this.updateLabelScale(event.transform.k);
            });
        
        svg.call(this.state.zoom);
        
        requestAnimationFrame(() => {
            svg.call(this.state.zoom.transform, this.state.initialTransform);
        });
    },
    
    initTooltip() {},
    
    // ==========================================
    // EVENT LISTENERS
    // ==========================================
    
    initEventListeners() {
        d3.select("#zoom-in").on("click", () => {
            this.refs.svg.transition()
                .duration(this.config.animation.fast)
                .call(this.state.zoom.scaleBy, 1.5);
        });
        
        d3.select("#zoom-out").on("click", () => {
            this.refs.svg.transition()
                .duration(this.config.animation.fast)
                .call(this.state.zoom.scaleBy, 0.75);
        });
        
        d3.select("#reset-view").on("click", () => this.resetView());
        d3.select("#rotate-view").on("click", () => this.toggleRotation());
        
        d3.select("#prev-block").on("click", () => this.selectPreviousBlock());
        d3.select("#next-block").on("click", () => this.selectNextBlock());
        d3.select("#retry-btn").on("click", () => this.init());
        
        this.keyHandler = (event) => {
            switch(event.key) {
                case "ArrowLeft":
                    event.preventDefault();
                    this.selectPreviousBlock();
                    break;
                case "ArrowRight":
                    event.preventDefault();
                    this.selectNextBlock();
                    break;
                case "Escape":
                    this.resetSelection();
                    break;
                case "r":
                case "R":
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        this.toggleRotation();
                    }
                    break;
            }
        };
        
        document.addEventListener("keydown", this.keyHandler);
        
        this.resizeHandler = this.debounce(() => this.handleResize(), 250);
        window.addEventListener("resize", this.resizeHandler);
    },
    
    // ==========================================
    // ROTATION
    // ==========================================
    
    toggleRotation() {
        const rotationGroup = d3.select("#rotation-group");
        const btn = d3.select("#rotate-view");
        
        this.state.isRotated = !this.state.isRotated;
        this.state.rotationAngle = this.state.isRotated ? 90 : 0;
        
        const cx = this.state.availableWidth * this.config.map.rotatedCenterX;
        const cy = this.state.height * this.config.map.rotatedCenterY;
        
        if (this.state.isRotated) {
            rotationGroup
                .transition()
                .duration(this.config.animation.normal)
                .attr("transform", `rotate(90, ${cx}, ${cy})`);
            
            if (this.state.labelSelection && !this.state.labelSelection.empty()) {
                this.state.labelSelection
                    .transition()
                    .duration(this.config.animation.normal)
                    .attr("transform", d => {
                        const [x, y] = this.state.path.centroid(d);
                        return `rotate(-90, ${x}, ${y})`;
                    });
            }
            
            btn.classed("rotated", true).text("‚Ü∫");
        } else {
            rotationGroup
                .transition()
                .duration(this.config.animation.normal)
                .attr("transform", "rotate(0, 0, 0)");
            
            if (this.state.labelSelection && !this.state.labelSelection.empty()) {
                this.state.labelSelection
                    .transition()
                    .duration(this.config.animation.normal)
                    .attr("transform", null);
            }
            
            btn.classed("rotated", false).text("‚Üª");
        }
    },
    
    // ==========================================
    // MAP DRAWING
    // ==========================================
    
    drawMap() {
        const blocksGroup = d3.select("#blocks-group");
        const labelsGroup = d3.select("#labels-group");
        
        blocksGroup.selectAll("*").remove();
        labelsGroup.selectAll("*").remove();
        
        const validFeatures = this.state.geoData.features.filter(f => 
            f.properties?.Field_Name && this.state.dataMap[f.properties.Field_Name]
        );
        
        if (validFeatures.length === 0) {
            throw new Error("No valid features with matching data");
        }
        
        console.log(`‚úì Drawing ${validFeatures.length} blocks`);
        
        this.state.blockSelection = blocksGroup.selectAll(".block")
            .data(validFeatures, d => d.properties.Field_Name)
            .enter()
            .append("path")
            .attr("class", "block")
            .attr("d", this.state.path)
            .attr("fill", d => this.getBlockColor(d))
            .on("click", (e, d) => this.onBlockClick(e, d))
            .on("mouseover", (e, d) => this.onBlockMouseOver(e, d))
            .on("mouseout", (e, d) => this.onBlockMouseOut(e, d));
        
        this.state.labelSelection = labelsGroup.selectAll(".block-label")
            .data(validFeatures, d => d.properties.Field_Name)
            .enter()
            .append("text")
            .attr("class", "block-label")
            .attr("font-size", this.config.map.labelBaseFontSize)
            .text(d => this.truncateLabel(d.properties.Field_Name))
            .attr("x", d => this.state.path.centroid(d)[0])
            .attr("y", d => this.state.path.centroid(d)[1]);
    },
    
    truncateLabel(name) {
        if (!name) return "";
        return name.length > this.config.thresholds.labelTruncate 
            ? name.substring(0, this.config.thresholds.labelTruncate - 2) + "..." 
            : name;
    },
    
    redrawMap() {
        if (!this.state.blockSelection || this.state.blockSelection.empty()) return;
        
        this.state.blockSelection.attr("d", this.state.path);
        
        if (this.state.labelSelection && !this.state.labelSelection.empty()) {
            this.state.labelSelection
                .attr("x", d => this.state.path.centroid(d)[0])
                .attr("y", d => this.state.path.centroid(d)[1]);
            
            if (this.state.isRotated) {
                this.state.labelSelection.attr("transform", d => {
                    const [x, y] = this.state.path.centroid(d);
                    return `rotate(-90, ${x}, ${y})`;
                });
            }
        }
    },
    
    // ==========================================
    // COLOR LOGIC
    // ==========================================
    
    getBlockColor(feature) {
        const fieldName = feature.properties?.Field_Name;
        if (!fieldName) return this.config.colors.default;
        
        const blockData = this.state.dataMap[fieldName];
        if (!blockData) return this.config.colors.default;
        
        const plantsPerHectare = parseFloat(blockData["Plants per hectare"]) || 0;
        const avgBunchWeight = parseFloat(blockData["Average Bunch Weight"]) || 0;
        const estimatedYield = plantsPerHectare * avgBunchWeight;
        
        if (fieldName === this.state.selectedBlock) {
            return this.config.colors.selected;
        } else if (estimatedYield > this.config.thresholds.highYield) {
            return this.config.colors.highYield;
        }
        
        return this.config.colors.default;
    },
    
    // ==========================================
    // BLOCK INTERACTIONS
    // ==========================================
    
    onBlockClick(event, d) {
        event.stopPropagation();
        const fieldName = d.properties.Field_Name;
        
        if (this.state.selectedBlock === fieldName) {
            this.resetSelection();
            return;
        }
        
        this.selectBlock(fieldName);
        this.zoomToBlock(d);
        
        d3.select(event.currentTarget)
            .interrupt()
            .attr("filter", "url(#pulseEffect)")
            .transition()
            .duration(this.config.animation.slow)
            .attr("filter", null);
    },
    
    onBlockMouseOver(event, d) {
        const fieldName = d.properties.Field_Name;
        const blockData = this.state.dataMap[fieldName];
        
        if (!blockData) return;
        
        d3.select(event.currentTarget)
            .interrupt()
            .raise()
            .transition()
            .duration(this.config.animation.hover)
            .attr("stroke-width", 8)
            .attr("stroke", "#ffffff")
            .attr("filter", "drop-shadow(0 12px 24px rgba(0,0,0,0.3)) brightness(1.1)")
            .attr("transform", "scale(1.02)");
        
        this.throttledShowTooltip(event, d);
    },
    
    onBlockMouseOut(event, d) {
        const selection = d3.select(event.currentTarget);
        const isSelected = d.properties.Field_Name === this.state.selectedBlock;
        
        selection
            .interrupt()
            .transition()
            .duration(this.config.animation.hover)
            .attr("stroke-width", isSelected ? 8 : 4)
            .attr("stroke", "#ffffff")
            .attr("filter", isSelected ? 
                "drop-shadow(0 0 20px rgba(230, 184, 0, 0.8)) brightness(1.1)" : 
                "drop-shadow(0 2px 3px rgba(0,0,0,0.1))")
            .attr("transform", "scale(1)");
        
        this.hideTooltip();
    },
    
    throttledShowTooltip: (function() {
        let lastCall = 0;
        let timeoutId = null;
        return function(event, d) {
            const now = Date.now();
            if (timeoutId) clearTimeout(timeoutId);
            
            timeoutId = setTimeout(() => {
                if (now - lastCall < this.config.tooltip.throttleMs) return;
                lastCall = now;
                this.showTooltip(event, d);
                timeoutId = null;
            }, 10);
        };
    })(),
    
    showTooltip(event, feature) {
        const fieldName = feature.properties.Field_Name;
        const rank = this.state.blockRanks[fieldName] || "‚Äî";
        
        let rankSuffix = "th";
        if (rank % 10 === 1 && rank % 100 !== 11) rankSuffix = "st";
        else if (rank % 10 === 2 && rank % 100 !== 12) rankSuffix = "nd";
        else if (rank % 10 === 3 && rank % 100 !== 13) rankSuffix = "rd";
        
        const rankText = rank !== "‚Äî" ? `${rank}${rankSuffix}` : "‚Äî";
        
        const tooltipHtml = `
            <div style="font-weight: 700; font-size: 15px; color: #ffd966; text-align: center;">${fieldName}</div>
            <div style="font-weight: 500; text-align: center; margin-top: 4px;">Rank: #${rankText}</div>
        `;
        
        this.refs.tooltip
            .html(tooltipHtml)
            .style("display", "block")
            .style("left", (event.pageX + this.config.tooltip.offsetX) + "px")
            .style("top", (event.pageY + this.config.tooltip.offsetY) + "px");
    },
    
    hideTooltip() {
        this.refs.tooltip.style("display", "none");
    },
    
    // ==========================================
    // SELECTION LOGIC
    // ==========================================
    
    selectBlock(fieldName) {
        if (this.state.selectedBlock && this.state.blockSelection) {
            this.state.blockSelection
                .filter(d => d.properties.Field_Name === this.state.selectedBlock)
                .classed("selected", false);
        }
        
        this.state.selectedBlock = fieldName;
        this.state.selectedBlockIndex = this.state.blocks.indexOf(fieldName);
        
        if (this.state.blockSelection) {
            this.state.blockSelection
                .filter(d => d.properties.Field_Name === fieldName)
                .classed("selected", true)
                .raise();
            
            this.state.blockSelection
                .filter(d => d.properties.Field_Name !== fieldName)
                .classed("faded", true);
            
            this.state.blockSelection.attr("fill", d => this.getBlockColor(d));
        }
        
        this.refs.panelTitle.html(`
            <span style="font-size: 45px; font-weight: 1000; letter-spacing: 0.01em; display: block; line-height: 1.2; font-family: var(--font-heading); color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.1);">${fieldName}</span>
            <button id="headerCloseBtn" class="header-close-btn" title="Clear selection (Escape)">‚úï</button>
        `);
        
        d3.select("#headerCloseBtn").on("click", () => this.resetSelection());
        
        this.refs.summaryStats.classed("hidden", true);
        this.refs.blockDetailsSection.classed("visible", true);
        
        this.updateBlockDetails();
        this.updateNavigationButtons();
        
        if (this.state.labelSelection) {
            this.state.labelSelection.classed("hidden", true);
        }
    },

    resetSelection() {
        if (this.state.blockSelection) {
            this.state.blockSelection.classed("selected", false);
            this.state.blockSelection.classed("faded", false);
            this.state.blockSelection.attr("fill", d => this.getBlockColor(d));
            
            this.state.blockSelection
                .attr("stroke-width", 4)
                .attr("stroke", "#000000")
                .attr("filter", "drop-shadow(0 2px 3px rgba(0,0,0,0.1))")
                .attr("transform", "scale(1)");
        }
        
        this.state.selectedBlock = null;
        this.state.selectedBlockIndex = -1;
        
        this.refs.panelTitle.html(`
            <span>üçå Elim Farms Dashboard <span style="font-size: 16px; opacity: 0.8; font-weight: 400; font-family: var(--font-primary);">v3.0</span></span>
        `);
        
        this.refs.summaryStats.classed("hidden", false);
        this.refs.blockDetailsSection.classed("visible", false);
        
        this.resetBlockDetails();
        
        if (this.state.labelSelection) {
            this.state.labelSelection.classed("hidden", false);
        }
        
        this.updateNavigationButtons();
        
        this.refs.svg.transition()
            .duration(this.config.animation.zoomOut)
            .call(this.state.zoom.transform, this.state.initialTransform);
    },
    
    resetView() {
        if (this.state.isRotated) {
            this.toggleRotation();
        }
        this.refs.svg.transition()
            .duration(this.config.animation.normal)
            .call(this.state.zoom.transform, this.state.initialTransform);
        this.resetSelection();
    },
    
    // ==========================================
    // ZOOM TO BLOCK
    // ==========================================
    
    zoomToBlock(feature) {
        const bounds = this.state.path.bounds(feature);
        const dx = bounds[1][0] - bounds[0][0];
        const dy = bounds[1][1] - bounds[0][1];
        const x = (bounds[0][0] + bounds[1][0]) / 2;
        const y = (bounds[0][1] + bounds[1][1]) / 2;
        
        const scale = Math.max(
            this.config.map.minZoomScale, 
            Math.min(
                this.config.map.maxZoomScale, 
                this.config.map.zoomPadding / Math.max(
                    dx / (this.state.availableWidth * 0.6),
                    dy / this.state.height
                )
            )
        );
        
        const nudge = this.state.dimensions.panelWidth * this.config.map.zoomNudgeFactor;
        const translate = [
            this.state.availableWidth * 0.65 - scale * x + nudge,
            this.state.height / 2 - scale * y
        ];
        
        this.refs.svg.transition()
            .duration(this.config.animation.zoomIn)
            .call(
                this.state.zoom.transform, 
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
            );
    },
    
    // ==========================================
    // NAVIGATION
    // ==========================================
    
    selectPreviousBlock() {
        if (this.state.blocks.length === 0) return;
        
        let newIndex;
        if (this.state.selectedBlockIndex === -1) {
            newIndex = this.state.blocks.length - 1;
        } else {
            newIndex = (this.state.selectedBlockIndex - 1 + this.state.blocks.length) % this.state.blocks.length;
        }
        
        this.navigateToBlock(newIndex);
    },
    
    selectNextBlock() {
        if (this.state.blocks.length === 0) return;
        
        let newIndex;
        if (this.state.selectedBlockIndex === -1) {
            newIndex = 0;
        } else {
            newIndex = (this.state.selectedBlockIndex + 1) % this.state.blocks.length;
        }
        
        this.navigateToBlock(newIndex);
    },
    
    navigateToBlock(index) {
        const blockName = this.state.blocks[index];
        const feature = this.state.geoData.features.find(f => 
            f.properties?.Field_Name === blockName
        );
        
        if (feature) {
            this.selectBlock(blockName);
            this.zoomToBlock(feature);
        }
    },
    
    // ==========================================
    // UI UPDATES
    // ==========================================
    
    updateNavigationButtons() {
        const hasBlocks = this.state.blocks.length > 0;
        d3.select("#prev-block").attr("disabled", hasBlocks ? null : true);
        d3.select("#next-block").attr("disabled", hasBlocks ? null : true);
    },
    
    updateLabelScale(scale) {
        if (!this.state.labelSelection || this.state.labelSelection.empty()) return;
        const labelScale = 1 / scale;
        this.state.labelSelection.attr("font-size", this.config.map.labelBaseFontSize * labelScale);
    },
    
    // ==========================================
    // DATA CALCULATIONS & SUMMARY
    // ==========================================
    
    updateSummary() {
        const data = this.state.csvData;
        
        const totalArea = data.reduce((sum, d) => sum + (parseFloat(d["Block Size"]) || 0), 0);
        const totalBlocks = data.length;
        
        let totalTrees = 0;
        let weightedBunchWeight = 0;
        let totalWeightedArea = 0;
        let totalYield = 0;
        let totalEstimatedYield = 0;
        let blocksWithData = 0;
        let highYieldCount = 0;
        
        data.forEach(d => {
            const plants = parseFloat(d["Plants per hectare"]) || 0;
            const weight = parseFloat(d["Average Bunch Weight"]) || 0;
            const size = parseFloat(d["Block Size"]) || 0;
            
            totalTrees += plants * size;
            weightedBunchWeight += weight * size;
            totalWeightedArea += size;
            
            if (plants && weight) {
                const blockYield = plants * weight;
                totalYield += blockYield;
                totalEstimatedYield += blockYield * size;
                blocksWithData++;
                
                if (blockYield > this.config.thresholds.highYield) {
                    highYieldCount++;
                }
            }
        });
        
        const farmDensity = totalArea > 0 ? totalTrees / totalArea : 0;
        const avgBunchWeight = totalWeightedArea > 0 ? weightedBunchWeight / totalWeightedArea : 0;
        const avgYield = blocksWithData > 0 ? totalYield / blocksWithData : 0;
        
        const updates = {
            "#total-area": `${totalArea.toFixed(1)} ha`,
            "#total-blocks": totalBlocks.toString(),
            "#total-trees": Math.round(totalTrees).toLocaleString(),
            "#farm-density": `${Math.round(farmDensity).toLocaleString()} plants/ha`,
            "#avg-bunch-weight-farm": `${avgBunchWeight.toFixed(1)} kg`,
            "#avg-yield": `${avgYield.toFixed(1)} kg/ha`,
            "#total-yield": `${Math.round(totalEstimatedYield).toLocaleString()} kg`,
            "#high-yield-count": highYieldCount.toString()
        };
        
        Object.entries(updates).forEach(([selector, value]) => {
            d3.select(selector).text(value);
        });
    },
    
    updateBlockDetails() {
        if (!this.state.selectedBlock) return;
        
        const blockData = this.state.dataMap[this.state.selectedBlock];
        if (!blockData) return;
        
        const plantsPerHectare = parseFloat(blockData["Plants per hectare"]) || 0;
        const avgBunchWeight = parseFloat(blockData["Average Bunch Weight"]) || 0;
        const blockSize = parseFloat(blockData["Block Size"]) || 0;
        const totalTrees = plantsPerHectare * blockSize;
        const estimatedYield = plantsPerHectare * avgBunchWeight;
        
        const updates = {
            "#block-size": `${blockSize.toFixed(1)} ha`,
            "#plants-per-hectare": plantsPerHectare.toLocaleString(),
            "#block-total-trees": Math.round(totalTrees).toLocaleString(),
            "#avg-bunch-weight": `${avgBunchWeight} kg`,
            "#block-yield": `${estimatedYield.toFixed(1)} kg/ha`
        };
        
        Object.entries(updates).forEach(([selector, value]) => {
            d3.select(selector).text(value);
        });
        
        const maxPlants = Math.max(...this.state.csvData.map(d => 
            parseFloat(d["Plants per hectare"]) || 0
        ));
        
        const densityPercent = maxPlants > 0 ? (plantsPerHectare / maxPlants) * 100 : 0;
        
        d3.select("#density-fill")
            .transition()
            .duration(this.config.animation.slow)
            .style("width", `${densityPercent}%`);
        
        d3.select("#density-label").text(`${plantsPerHectare.toLocaleString()} plants/ha`);
        d3.select("#density-chart-label").text(`${Math.round(densityPercent)}% of max`);
    },
    
    resetBlockDetails() {
        const resetValues = {
            "#block-size": "-",
            "#plants-per-hectare": "-",
            "#block-total-trees": "-",
            "#avg-bunch-weight": "-",
            "#block-yield": "-",
            "#density-label": "-",
            "#density-chart-label": "0%"
        };
        
        Object.entries(resetValues).forEach(([selector, value]) => {
            d3.select(selector).text(value);
        });
        
        d3.select("#density-fill").style("width", "0%");
    },
    
    // ==========================================
    // LOADING & ERROR STATES
    // ==========================================
    
    showLoading(show, text = "Loading...") {
        if (!this.refs?.loading) {
            console.warn("showLoading called before DOM cached");
            return;
        }
        this.refs.loading.style("display", show ? "flex" : "none");
        if (this.refs.loadingText) {
            this.refs.loadingText.text(text);
        }
    },
    
    showError(message) {
        if (!this.refs?.errorState) {
            console.error("Error:", message);
            alert("Error: " + message);
            return;
        }
        this.refs.errorState.style("display", "block");
        this.refs.errorMessage.text(message || "An error occurred. Please try again.");
    },
    
    hideError() {
        this.refs?.errorState?.style("display", "none");
    },
    
    // ==========================================
    // RESIZE HANDLER
    // ==========================================
    
    handleResize() {
        const container = this.refs.container;
        const width = container.node().clientWidth;
        const height = container.node().clientHeight;
        const panelWidth = parseInt(getComputedStyle(document.getElementById('panel')).width) || 420;
        const availableWidth = width - panelWidth;
        
        this.state.dimensions = { width, height, availableWidth, panelWidth };
        this.state.width = width;
        this.state.height = height;
        this.state.availableWidth = availableWidth;
        
        this.refs.svg.attr("width", width).attr("height", height);
        
        const horizontalNudge = availableWidth * this.config.map.horizontalNudgeRatio;
        const centerX = (availableWidth * this.config.map.defaultCenterX) + horizontalNudge;
        const centerY = height * this.config.map.defaultCenterY;
        this.state.projection.translate([centerX, centerY]);
        
        this.redrawMap();
    },
    
    // ==========================================
    // UTILITIES
    // ==========================================
    
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },
    
    // ==========================================
    // CLEANUP
    // ==========================================
    
    destroy() {
        console.log("üßπ Cleaning up dashboard...");
        window.removeEventListener("resize", this.resizeHandler);
        document.removeEventListener("keydown", this.keyHandler);
        d3.selectAll("*").interrupt();
        console.log("‚úÖ Cleanup complete");
    }
};

// ==========================================
// INITIALIZATION
// ==========================================

if (document.readyState === 'loading') {
    document.addEventListener("DOMContentLoaded", () => {
        FarmDashboard.init();
    });
} else {
    FarmDashboard.init();
}

window.FarmDashboard = FarmDashboard;
</script>
</body>
</html>
